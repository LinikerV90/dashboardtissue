
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gerar QRCodes dos Motores – SERVOS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- QRCode LIB: PRECISA vir antes do seu script principal -->
  <script/cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js</script>

  <style>
    :root { --azul-suzano: #0051A2; --cinza: #f2f4f7; }
    body { font-family: Inter, Arial, sans-serif; margin: 24px; background: var(--cinza); }
    h1 { margin: 0 0 8px; color: var(--azul-suzano); }
    .desc { margin: 0 0 16px; color: #333; }
    .config { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; margin-bottom:16px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:16px; }
    .item { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px; text-align:center; }
    .motor { font-weight:600; margin-bottom:8px; color:#111; }
    .btn { margin-top:8px; display:inline-block; padding:8px 12px; background:var(--azul-suzano); color:#fff; border-radius:8px; text-decoration:none; }
    .meta { margin-top:20px; font-size:12px; color:#666; }
    .loading { padding:12px 16px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; display:inline-block; }
    .error { padding:12px 16px; background:#ffeceb; border:1px solid #f5c2c0; border-radius:12px; color:#7a1d18; }
    .bar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:8px; }
    input[type=text] { width: 420px; max-width: 100%; padding:8px 10px; border:1px solid #cfd6de; border-radius:8px; }
    .small { font-size:12px; color:#555; }
  </style>
</head>
<body>
  <h1>Gerar QRCodes – Aba “SERVOS”</h1>
  <p class="desc">Este utilitário lê os IDs dos motores na coluna <strong>A</strong> da planilha e cria QRs que apontam para <code>https://dashboardtissue.com.br/ar.html?motor=ID</code>.</p>

  <div class="config">
    <div class="bar">
      <label for="sheetId"><strong>Google Sheet ID</strong></label>
      <input id="sheetId" type="text" value="1W9OPl0BG72_6t0nGy1kaDqfIICkLgG8YnkD_Y5uCb4k" />
      <span class="small">Já preenchido com a sua planilha.</span>
    </div>
    <div class="bar">
      <label for="sheetName"><strong>Aba</strong></label>
      <input id="sheetName" type="text" value="SERVOS" />
    </div>
    <div class="bar">
      <label for="baseUrl"><strong>Base do link</strong></label>
      <!-- ATENÇÃO: sem /br/ -->
      <input id="baseUrl" type="text" value="https://dashboardtissue.com.br/ar.html?motor=" />
    </div>

    <!-- Botões com IDs -> exigidos pelo JS -->
    <div class="bar">
      #Ler planilha e gerar QRs</a>
      <a id="btnDownloadAlla>
    </div>

    <p class="small">
      Obs.: é necessário que a planilha esteja com “Qualquer pessoa com o link pode visualizar” ou
      <em>Publish to the Web</em> para leitura pública pelo navegador.
    </p>
  </div>

  <div id="status" class="loading">Aguardando...</div>
  <div id="grid" class="grid" style="display:none;"></div>
  <p class="meta">Dica: após gerar, clique em <em>Baixar PNG</em> para salvar cada QR. Você pode imprimir e afixar nos motores.</p>

  <!-- Seu script PRINCIPAL (vem DEPOIS dos elementos do DOM) -->
  <script>
    async function fetchMotorIds(sheetId, sheetName) {
      const tq = "select A where A is not null";
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&tqx=out:json&tq=${encodeURIComponent(tq)}`;
      const res = await fetch(url);
      const txt = await res.text();
      const jsonStr = txt.substring(txt.indexOf('{'), txt.lastIndexOf('}') + 1);
      const obj = JSON.parse(jsonStr);
      const rows = obj?.table?.rows || [];
      const ids = rows
        .map(r => (r.c && r.c[0] && r.c[0].v != null) ? String(r.c[0].v).trim() : null)
        .filter(v => v && v.length > 0);
      const seen = new Set(); const unique = [];
      for (const id of ids) { if (!seen.has(id)) { seen.add(id); unique.push(id); } }
      return unique;
    }

    function makeQR(container, text, label) {
      const wrap = document.createElement('div');
      wrap.className = 'item';

      const title = document.createElement('div');
      title.className = 'motor';
      title.textContent = label || text;
      wrap.appendChild(title);

      const qrel = document.createElement('div');
      new QRCode(qrel, { text, width: 256, height: 256, correctLevel: QRCode.CorrectLevel.H });
      wrap.appendChild(qrel);

      const a = document.createElement('a');
      a.className = 'btn';
      a.textContent = 'Baixar PNG';
      a.href = '#';
      a.addEventListener('click', (e) => {
        e.preventDefault();
        const img = qrel.querySelector('img') || qrel.querySelector('canvas');
        const dataUrl = img?.src || (img ? img.toDataURL('image/png') : null);
        if (!dataUrl) return;
        const link = document.createElement('a');
        link.download = `${(label||text).replace(/[^a-zA-Z0-9_-]/g,'_')}.png`;
        link.href = dataUrl;
        link.click();
      });
      wrap.appendChild(a);

      container.appendChild(wrap);
    }

    async function generateZIPAll() {
      if (!window.JSZip) {
        await Promise.all([
          new Promise((res, rej)=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js'; s.onload=res; s.onerror=rej; document.body.appendChild(s); }),
          new Promise((res, rej)=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js'; s.onload=res; s.onerror=rej; document.body.appendChild(s); })
        ]);
      }
      const zip = new JSZip();
      const items = document.querySelectorAll('.grid .item');
      for (const item of items) {
        const name = item.querySelector('.motor').textContent;
        const qrel = item.querySelector('div:nth-child(2)');
        const img = qrel.querySelector('img') || qrel.querySelector('canvas');
        const dataUrl = img?.src || (img ? img.toDataURL('image/png') : null);
        if (!dataUrl) continue;
        const base64 = dataUrl.split(',')[1];
        zip.file(`${name.replace(/[^a-zA-Z0-9_-]/g,'_')}.png`, base64, {base64:true});
      }
      const blob = await zip.generateAsync({type:'blob'});
      saveAs(blob, 'QRCodes_SERVOS.zip');
    }

    function main() {
      const sheetIdInput = document.getElementById('sheetId');
      const sheetNameInput = document.getElementById('sheetName');
      const baseUrlInput  = document.getElementById('baseUrl');
      const btnLoad = document.getElementById('btnLoad');
      const btnZip  = document.getElementById('btnDownloadAll');
      const status  = document.getElementById('status');
      const grid    = document.getElementById('grid');

      btnLoad.addEventListener('click', async (e) => {
        e.preventDefault();
        status.className = 'loading';
        status.textContent = 'Carregando dados da planilha...';
        try {
          const sheetId = sheetIdInput.value.trim();
          const sheetName = sheetNameInput.value.trim();
          const base = baseUrlInput.value.trim();
          const ids = await fetchMotorIds(sheetId, sheetName);
          if (!ids.length) throw new Error('Nenhum ID encontrado na coluna A.');

          grid.innerHTML = '';
          grid.style.display = 'grid';
          status.style.display = 'none';

          ids.forEach(id => {
            const url = base + encodeURIComponent(id);
            makeQR(grid, url, id);
          });

        } catch (err) {
          status.className = 'error';
          status.textContent = 'Erro: ' + err.message;
          console.error(err);
        }
      });

      btnZip.addEventListener('click', async (e) => {
        e.preventDefault();
        try { await generateZIPAll(); }
        catch (err) { alert('Falha ao gerar ZIP: ' + err.message); }
      });
    }

    document.addEventListener('DOMContentLoaded', main);
  </script>
</body>
</html>
