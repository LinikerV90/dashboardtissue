<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>AR Dashboard</title>

  <!-- A-FRAME + MINDAR (VERSÃO CORRETA) -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.0/dist/mindar-image-aframe.prod.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
      font-family: Arial;
    }

    a-scene {
      width: 100vw !important;
      height: 100vh !important;
      position: fixed;
      top: 0;
      left: 0;
      overflow: hidden;
    }

    .error {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 8px 12px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      border-radius: 6px;
      z-index: 9999;
      display: none;
    }
  </style>
</head>

<body>

<div class="error" id="errorBox"></div>

<a-scene
  mindar-image="imageTargetSrc: ./asset/targets.mind;"
  color-space="sRGB"
  renderer="colorManagement: true, physicallyCorrectLights"
  vr-mode-ui="enabled: false"
  device-orientation-permission-ui="enabled: false">

  <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

  <a-entity mindar-image-target="targetIndex: 0" id="anchor">

    <a-entity id="gaugeTorque" position="0 0.6 0" visible="false">
      <a-cylinder height="0.05" radius="0.5" color="#0044ff"></a-cylinder>
      <a-text id="torqueLabel" value="Torque: 0" position="-0.4 0.1 0.1" color="#fff" width="2"></a-text>
    </a-entity>

    <a-entity id="gaugeCorrente" position="0 0 0" visible="false">
      <a-cylinder height="0.05" radius="0.5" color="#00ff44"></a-cylinder>
      <a-text id="correnteLabel" value="Corrente: 0" position="-0.4 0.1 0.1" color="#fff" width="2"></a-text>
    </a-entity>

    <a-entity id="gaugeTemp" position="0 -0.6 0" visible="false">
      <a-cylinder height="0.05" radius="0.5" color="#ff4400"></a-cylinder>
      <a-text id="tempLabel" value="Temp: 0" position="-0.4 0.1 0.1" color="#fff" width="2"></a-text>
    </a-entity>

  </a-entity>

</a-scene>

<script>
  function showError(msg) {
    const box = document.getElementById("errorBox");
    box.innerText = msg;
    box.style.display = "block";
  }

  const urlParams = new URLSearchParams(window.location.search);
  const motorId = urlParams.get("motor");

  if (!motorId) showError("Nenhum ID de motor informado. Use ?motor=MTR001");

  console.log("Motor selecionado:", motorId);

  async function loadMotorData() {
    try {
      const res = await fetch(
        `https://script.google.com/macros/s/AKfycbw_1jVhRGzErkeQgBSu4JQTbh_24150E5DB8jP84VfTKEd08ESrhtlWPgau0KeWnKVj/exec?id=${motorId}`
      );

      const data = await res.json();
      console.log("JSON recebido:", data);

      if (!data.id) {
        showError("Motor não encontrado.");
        return;
      }

      document.getElementById("torqueLabel").setAttribute("value", `Torque: ${data.torque}`);
      document.getElementById("correnteLabel").setAttribute("value", `Corrente: ${data.corrente}`);
      document.getElementById("tempLabel").setAttribute("value", `Temp: ${data.temperatura}`);

    } catch (err) {
      console.error(err);
      showError("Erro ao consultar Apps Script.");
    }
  }

  loadMotorData();

  const anchor = document.getElementById("anchor");

  anchor.addEventListener("targetFound", () => {
    console.log("Imagem detectada! Mostrando gauges.");
    document.getElementById("gaugeTorque").setAttribute("visible", true);
    document.getElementById("gaugeCorrente").setAttribute("visible", true);
    document.getElementById("gaugeTemp").setAttribute("visible", true);
  });

  anchor.addEventListener("targetLost", () => {
    console.log("Imagem perdida. Ocultando gauges.");
    document.getElementById("gaugeTorque").setAttribute("visible", false);
    document.getElementById("gaugeCorrente").setAttribute("visible", false);
    document.getElementById("gaugeTemp").setAttribute("visible", false);
  });
</script>

</body>
</html>
