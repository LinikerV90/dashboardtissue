<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR Motores – Suzano</title>

  <!-- A-Frame + MindAR -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <!-- Gauges -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-gauges@2.1.7/gauge.min.js"></script>

  <style>
    body { margin:0; overflow:hidden; font-family: Arial; background:#000; }
    canvas { display:none; } /* canvases escondidos, usados como textura */
    .arjs-loader {
      position: absolute; top:0; left:0; width:100%; height:100%;
      display:flex; justify-content:center; align-items:center;
      background: rgba(0,0,0,0.85); color:#fff; font-size:18px; z-index:9999;
    }
    .error {
      position:absolute; top:10px; left:10px; padding:8px; background:rgba(0,0,0,0.6);
      color:#fff; border-radius:6px; display:none; z-index:10000;
    }
  </style>
</head>
<body>

<div class="arjs-loader" id="loader">Carregando AR... aguarde</div>
<div class="error" id="errbox"></div>

<!-- Canvases dos gauges -->
<canvas id="gTorque" width="512" height="512"></canvas>
<canvas id="gCorrente" width="512" height="512"></canvas>
<canvas id="gTemperatura" width="512" height="512"></canvas>

<a-scene mindar-image="imageTargetSrc: assets/targets.mind;" embedded color-space="sRGB"
         renderer="colorManagement: true, physicallyCorrectLights: true"
         vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: true">

  <a-camera position="0 0 0"></a-camera>

</a-scene>

<script>
(async function(){

  const SHEET_ID   = '1W9OPl0BG72_6t0nGy1kaDqfIICkLgG8YnkD_Y5uCb4k';
  const SHEET_NAME = 'SERVOS';
  const TARGET_INDEX = 0; // usamos uma única imagem como alvo

  function showError(msg){
    const e = document.getElementById('errbox');
    e.style.display = 'block';
    e.textContent = msg;
    console.error(msg);
  }

  function getParam(name){
    return new URLSearchParams(location.search).get(name) || '';
  }

  async function fetchMotor(nome){
    const tq = `select A,B,C,D where A='${nome}' limit 1`;
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tqx=out:json&tq=${encodeURIComponent(tq)}`;
    const txt = await fetch(url).then(r => r.text());
    const json = JSON.parse(txt.substring(txt.indexOf('{'), txt.lastIndexOf('}')+1));
    if(!json.table.rows.length) throw new Error(`Motor "${nome}" não encontrado na planilha.`);
    const row = json.table.rows[0].c;
    return {
      nome: row[0]?.v,
      torque: Number(row[1]?.v) || 0,
      corrente: Number(row[2]?.v) || 0,
      temperatura: Number(row[3]?.v) || 0
    };
  }

  function createGauges(){
    return {
      torqueGauge: new RadialGauge({
        renderTo:'gTorque', width:512, height:512, units:'Torque (Nm)',
        minValue:0, maxValue:100, majorTicks:['0','20','40','60','80','100'], value:0
      }).draw(),
      correnteGauge: new RadialGauge({
        renderTo:'gCorrente', width:512, height:512, units:'Corrente (A)',
        minValue:0, maxValue:100, majorTicks:['0','20','40','60','80','100'], value:0
      }).draw(),
      temperaturaGauge: new RadialGauge({
        renderTo:'gTemperatura', width:512, height:512, units:'°C',
        minValue:0, maxValue:120, majorTicks:['0','20','40','60','80','100','120'], value:0
      }).draw()
    };
  }

  function updateGauges(g, d){
    g.torqueGauge.value = d.torque; g.torqueGauge.draw();
    g.correnteGauge.value = d.corrente; g.correnteGauge.draw();
    g.temperaturaGauge.value = d.temperatura; g.temperaturaGauge.draw();
  }

  function buildAnchor(data){
    const scene = document.querySelector('a-scene');
    const existing = scene.querySelectorAll('[data-ar-anchor]');
    existing.forEach(n => n.parentNode && n.parentNode.removeChild(n));

    const anchor = document.createElement('a-entity');
    anchor.setAttribute('mindar-image-target', `targetIndex: ${TARGET_INDEX}`);
    anchor.setAttribute('data-ar-anchor', 'true');

    const title = document.createElement('a-text');
    title.setAttribute('value', data.nome);
    title.setAttribute('color','#0051A2');
    title.setAttribute('align','center');
    title.setAttribute('position','0 0.9 0');
    title.setAttribute('scale','1.2 1.2 1');

    const planeTorque = document.createElement('a-plane');
    planeTorque.setAttribute('position','-0.6 0.25 0');
    planeTorque.setAttribute('width','0.7');
    planeTorque.setAttribute('height','0.7');
    planeTorque.setAttribute('material','src: #gTorque; transparent: true');

    const planeCorr = document.createElement('a-plane');
    planeCorr.setAttribute('position','0.6 0.25 0');
    planeCorr.setAttribute('width','0.7');
    planeCorr.setAttribute('height','0.7');
    planeCorr.setAttribute('material','src: #gCorrente; transparent: true');

    const planeTemp = document.createElement('a-plane');
    planeTemp.setAttribute('position','0 -0.4 0');
    planeTemp.setAttribute('width','1.0');
    planeTemp.setAttribute('height','0.7');
    planeTemp.setAttribute('material','src: #gTemperatura; transparent: true');

    anchor.appendChild(title);
    anchor.appendChild(planeTorque);
    anchor.appendChild(planeCorr);
    anchor.appendChild(planeTemp);

    scene.appendChild(anchor);
  }

  try {
    const motorNome = getParam('motor');
    if(!motorNome) throw new Error('Parâmetro ?motor= ausente na URL.');

    const gauges = createGauges();
    const data = await fetchMotor(motorNome);

    updateGauges(gauges, data);
    buildAnchor(data);

    document.getElementById('loader').style.display='none';

    setInterval(async ()=>{
      const d = await fetchMotor(motorNome);
      updateGauges(gauges,d);
    }, 10000);

  } catch(e){
    document.getElementById('loader').style.display='none';
    showError(e.message);
  }

})();
</script>

</body>
</html>
