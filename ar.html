<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR Motores – Suzano</title>

  <!-- A-Frame + MindAR -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <!-- Gauges -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-gauges@2.1.7/gauge.min.js"></script>

  <style>
    body { margin:0; overflow:hidden; background:#000; font-family: Arial; }
    canvas { display:none; }
    .error { position:absolute; top:10px; left:10px; z-index:1000; color:#fff; background:rgba(0,0,0,0.5); padding:8px; border-radius:5px; display:none;}
    a-scene { width: 100vw; height: 100vh; position: fixed; top: 0; left: 0; overflow: hidden; }
  </style>
</head>

<body>

<div class="error" id="errbox"></div>

<!-- Canvases dos gauges -->
<canvas id="gTorque" width="512" height="512"></canvas>
<canvas id="gCorrente" width="512" height="512"></canvas>
<canvas id="gTemperatura" width="512" height="512"></canvas>

<a-scene 
  mindar-image="imageTargetSrc: asset/targets.mind;"
  color-space="sRGB"
  vr-mode-ui="enabled: false"
  device-orientation-permission-ui="enabled: true"
>
  <!-- Camera -->
  <a-camera position="0 0 0"></a-camera>

  <!-- Anchor para a imagem alvo -->
  <a-entity mindar-image-target="targetIndex: 0" id="anchor">
      <!-- Título do motor -->
      <a-text id="titulo"
              value="Carregando..."
              position="0 1 0"
              align="center"
              color="#00AEEF"
              width="2">
      </a-text>

      <!-- Planos para os gauges (posicionados horizontalmente para não sobrepor) -->
      <a-plane id="planeTorque" position="-1 0.3 0" width="0.8" height="0.8"></a-plane>
      <a-plane id="planeCorrente" position="0 0.3 0" width="0.8" height="0.8"></a-plane>
      <a-plane id="planeTemp" position="1 0.3 0" width="0.8" height="0.8"></a-plane>
  </a-entity>
</a-scene>

<script>
(async function(){
  const errbox = document.getElementById('errbox');
  function showError(msg){
    errbox.style.display = 'block';
    errbox.textContent = msg;
    console.error(msg);
  }

  function getParam(name){
    return new URLSearchParams(location.search).get(name) || '';
  }

  async function fetchMotor(id){
    try {
      const url = `https://script.google.com/macros/s/AKfycbw_1jVhRGzErkeQgBSu4JQTbh_24150E5DB8jP84VfTKEd08ESrhtlWPgau0KeWnKVj/exec?id=${encodeURIComponent(id)}`;
      const res = await fetch(url);
      const data = await res.json();
      if(!data || !data.id) throw new Error('Motor não encontrado na planilha.');
      return data;
    } catch(e){
      showError(e.message);
      throw e;
    }
  }

  function createGauges(){
    return {
      torqueGauge: new RadialGauge({
        renderTo: 'gTorque', width:512, height:512, units:'Torque (Nm)',
        minValue:0, maxValue:100, majorTicks:['0','20','40','60','80','100'], minorTicks:4,
        borders:true, value:0, highlights:[{from:0,to:60,color:'#30B32D'},{from:60,to:85,color:'#FFDD00'},{from:85,to:100,color:'#F03E3E'}]
      }).draw(),

      correnteGauge: new RadialGauge({
        renderTo: 'gCorrente', width:512, height:512, units:'Corrente (A)',
        minValue:0, maxValue:100, majorTicks:['0','20','40','60','80','100'], minorTicks:4,
        borders:true, value:0, highlights:[{from:0,to:60,color:'#30B32D'},{from:60,to:85,color:'#FFDD00'},{from:85,to:100,color:'#F03E3E'}]
      }).draw(),

      temperaturaGauge: new RadialGauge({
        renderTo: 'gTemperatura', width:512, height:512, units:'°C',
        minValue:0, maxValue:120, majorTicks:['0','20','40','60','80','100','120'], minorTicks:4,
        borders:true, value:0, highlights:[{from:0,to:70,color:'#30B32D'},{from:70,to:90,color:'#FFDD00'},{from:90,to:120,color:'#F03E3E'}]
      }).draw()
    };
  }

  const gauges = createGauges();

  try {
    const motorId = getParam('motor');
    if(!motorId) throw new Error('Parâmetro ?motor= ausente na URL.');

    const data = await fetchMotor(motorId);

    const anchor = document.querySelector("#anchor");

    anchor.addEventListener("targetFound", () => {
      console.log("Imagem detectada! Mostrando gauges.");

      // Atualiza título
      document.getElementById('titulo').setAttribute('value', data.id);

      // Atualiza gauges
      gauges.torqueGauge.value = data.torque;
      gauges.correnteGauge.value = data.corrente;
      gauges.temperaturaGauge.value = data.temperatura;
      gauges.torqueGauge.draw();
      gauges.correnteGauge.draw();
      gauges.temperaturaGauge.draw();

      // Vincula os canvases aos planos do A-Frame
      document.getElementById('planeTorque').setAttribute('material', 'src: #gTorque; transparent: true');
      document.getElementById('planeCorrente').setAttribute('material', 'src: #gCorrente; transparent: true');
      document.getElementById('planeTemp').setAttribute('material', 'src: #gTemperatura; transparent: true');

      // Atualizações contínuas enquanto a imagem estiver visível
      setInterval(async () => {
        const d = await fetchMotor(motorId);
        gauges.torqueGauge.value = d.torque;
        gauges.correnteGauge.value = d.corrente;
        gauges.temperaturaGauge.value = d.temperatura;
        gauges.torqueGauge.draw();
        gauges.correnteGauge.draw();
        gauges.temperaturaGauge.draw();
      }, 8000);
    });

  } catch(err){
    showError(err.message);
  }
})();
</script>

</body>
</html>
