<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR Motores – Suzano</title>

  <!-- A-Frame + AR.js (profissional, estável e industrial) -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.rawgit.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.min.js"></script>

  <!-- Gauges -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-gauges@2.1.7/gauge.min.js"></script>

  <style>
    body { margin:0; overflow:hidden; background:#000; font-family: Arial; }
    canvas { display:none; } /* canvases escondidos, usados só como textura */
  </style>
</head>

<body>

<!-- Canvases dos gauges -->
<canvas id="gTorque" width="512" height="512"></canvas>
<canvas id="gCorrente" width="512" height="512"></canvas>
<canvas id="gTemperatura" width="512" height="512"></canvas>

<a-scene 
  vr-mode-ui="enabled: false"
  embedded
  arjs="trackingMethod: barcode; barcodeType: aruco; debugUIEnabled: false;"
>
  <!-- CAMERA -->
  <a-entity camera></a-entity>

  <!-- MARCADOR ARUCO – valor 0 (substitua conforme motor) -->
  <a-marker type="barcode" value="0" id="arucoMarker">

      <!-- Título do motor -->
      <a-text id="titulo"
              value="Carregando..."
              position="0 1 0"
              align="center"
              color="#00AEEF"
              width="2">
      </a-text>

      <!-- Painel Torque -->
      <a-plane position="-0.7 0.25 0"
               width="0.9" height="0.9"
               material="src: #gTorque; transparent: true">
      </a-plane>

      <!-- Painel Corrente -->
      <a-plane position="0.7 0.25 0"
               width="0.9" height="0.9"
               material="src: #gCorrente; transparent: true">
      </a-plane>

      <!-- Painel Temperatura -->
      <a-plane position="0 -0.6 0"
               width="1.4" height="0.9"
               material="src: #gTemperatura; transparent: true">
      </a-plane>

  </a-marker>

</a-scene>

<script>
/* ===================
   1. CONFIGURAÇÕES
   =================== */
const SHEET_ID   = "1W9OPl0BG72_6t0nGy1kaDqfIICkLgG8YnkD_Y5uCb4k";
const SHEET_NAME = "SERVOS";

// Motor → número do marcador ArUco
const ARUCO_MAP = {
  "MOTOR_01": 0,
  "MOTOR_02": 1,
  "MOTOR_03": 2
};

/* ===================
   2. PARÂMETROS DA URL
   =================== */
function getParam(p){
  return new URLSearchParams(location.search).get(p);
}

const ID = getParam("motor");

/* ===================
   3. GAUGES
   =================== */
function createGauges(){
  return {
    t: new RadialGauge({
      renderTo:"gTorque", width:512, height:512,
      minValue:0, maxValue:100, units:"Torque (Nm)",
      value:0, majorTicks:["0","20","40","60","80","100"]
    }).draw(),

    c: new RadialGauge({
      renderTo:"gCorrente", width:512, height:512,
      minValue:0, maxValue:100, units:"Corrente (A)",
      value:0
    }).draw(),

    temp: new RadialGauge({
      renderTo:"gTemperatura", width:512, height:512,
      minValue:0, maxValue:120, units:"Temperatura (°C)",
      value:0
    }).draw()
  };
}

const gauges = createGauges();

/* ===================
   4. BUSCAR DADOS DE UM MOTOR
   =================== */
async function fetchMotor(id){
  const tq = `select A,B,C,D where A='${id}' limit 1`;
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&tqx=out:json&tq=${encodeURIComponent(tq)}`;

  const txt = await fetch(url).then(r => r.text());
  const json = JSON.parse(txt.substring(txt.indexOf("{"), txt.lastIndexOf("}")+1));
  const row = json.table.rows[0].c;

  return {
    nome: row[0].v,
    torque: row[1].v,
    corrente: row[2].v,
    temperatura: row[3].v
  };
}

/* ===================
   5. INICIALIZAÇÃO
   =================== */
async function init(){
  if(!ID){
    alert("Erro: use ?motor=MOTOR_01");
    return;
  }

  const markerId = ARUCO_MAP[ID];
  if(markerId === undefined){
    alert("Erro: motor não mapeado para marcador ArUco.");
    return;
  }

  // define em qual marcador o A-Frame vai renderizar
  document.getElementById("arucoMarker").setAttribute("value", markerId);

  // carregar dados iniciais
  const d = await fetchMotor(ID);

  document.getElementById("titulo").setAttribute("value", d.nome);

  gauges.t.value = d.torque;
  gauges.t.draw();
  gauges.c.value = d.corrente;
  gauges.c.draw();
  gauges.temp.value = d.temperatura;
  gauges.temp.draw();

  // atualizações contínuas
  setInterval(async () => {
    const d = await fetchMotor(ID);
    gauges.t.value = d.torque;
    gauges.c.value = d.corrente;
    gauges.temp.value = d.temperatura;

    gauges.t.draw();
    gauges.c.draw();
    gauges.temp.draw();
  }, 8000);
}

init();
</script>

</body>
</html>
