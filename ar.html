<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR Motores – Suzano</title>

  <!-- A-Frame + MindAR (UMD, estável) -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <!-- Gauges -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-gauges@2.1.7/gauge.min.js"></script>

  <style>
    body { margin:0; overflow:hidden; background:#000; font-family: Arial; }
    canvas { display:none; } /* canvases escondidos, usados só como textura */
    .error { position:absolute; top:10px; left:10px; z-index:1000; color:#fff; background:rgba(0,0,0,0.5); padding:8px; border-radius:5px; display:none;}
  </style>
</head>

<body>

<div class="error" id="errbox"></div>

<!-- Canvases dos gauges -->
<canvas id="gTorque" width="512" height="512"></canvas>
<canvas id="gCorrente" width="512" height="512"></canvas>
<canvas id="gTemperatura" width="512" height="512"></canvas>

<a-scene 
  mindar-image="imageTargetSrc: asset/targets.mind;"
  color-space="sRGB"
  vr-mode-ui="enabled: false"
  device-orientation-permission-ui="enabled: true"
  embedded
>
  <!-- Camera -->
  <a-camera position="0 0 0"></a-camera>

  <!-- Anchor para a imagem alvo -->
  <a-entity mindar-image-target="targetIndex: 0" id="anchor">

      <!-- Título do motor -->
      <a-text id="titulo"
              value="Carregando..."
              position="0 1 0"
              align="center"
              color="#00AEEF"
              width="2">
      </a-text>

      <!-- Painel Torque -->
      <a-plane position="-0.7 0.25 0"
               width="0.9" height="0.9"
               material="src: #gTorque; transparent: true">
      </a-plane>

      <!-- Painel Corrente -->
      <a-plane position="0.7 0.25 0"
               width="0.9" height="0.9"
               material="src: #gCorrente; transparent: true">
      </a-plane>

      <!-- Painel Temperatura -->
      <a-plane position="0 -0.6 0"
               width="1.4" height="0.9"
               material="src: #gTemperatura; transparent: true">
      </a-plane>

  </a-entity>
</a-scene>

<script>
(async function(){
  const SHEET_ID   = "1W9OPl0BG72_6t0nGy1kaDqfIICkLgG8YnkD_Y5uCb4k";
  const SHEET_NAME = "SERVOS";

  const errbox = document.getElementById('errbox');
  function showError(msg){
    errbox.style.display = 'block';
    errbox.textContent = msg;
    console.error(msg);
  }

  function getParam(name){
    return new URLSearchParams(location.search).get(name) || '';
  }

  async function fetchMotor(id){
    try {
      const tq = `select A,B,C,D where B='${id}' limit 1`;
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tqx=out:json&tq=${encodeURIComponent(tq)}`;
      const txt = await fetch(url).then(r => r.text());
      const jsonStr = txt.substring(txt.indexOf('{'), txt.lastIndexOf('}')+1);
      const obj = JSON.parse(jsonStr);
      const row = (obj.table.rows && obj.table.rows[0]) ? obj.table.rows[0].c : null;
      if(!row) throw new Error('Motor não encontrado na planilha.');
      return {
        nome: row[0]?.v || id,
        torque: Number(row[1]?.v) || 0,
        corrente: Number(row[2]?.v) || 0,
        temperatura: Number(row[3]?.v) || 0
      };
    } catch(e){
      showError(e.message);
      throw e;
    }
  }

  function createGauges(){
    return {
      torqueGauge: new RadialGauge({
        renderTo: 'gTorque', width:512, height:512, units:'Torque (Nm)',
        minValue:0, maxValue:100, majorTicks:['0','20','40','60','80','100'], minorTicks:4,
        borders:true, value:0, highlights:[{from:0,to:60,color:'#30B32D'},{from:60,to:85,color:'#FFDD00'},{from:85,to:100,color:'#F03E3E'}]
      }).draw(),

      correnteGauge: new RadialGauge({
        renderTo: 'gCorrente', width:512, height:512, units:'Corrente (A)',
        minValue:0, maxValue:100, majorTicks:['0','20','40','60','80','100'], minorTicks:4,
        borders:true, value:0, highlights:[{from:0,to:60,color:'#30B32D'},{from:60,to:85,color:'#FFDD00'},{from:85,to:100,color:'#F03E3E'}]
      }).draw(),

      temperaturaGauge: new RadialGauge({
        renderTo: 'gTemperatura', width:512, height:512, units:'°C',
        minValue:0, maxValue:120, majorTicks:['0','20','40','60','80','100','120'], minorTicks:4,
        borders:true, value:0, highlights:[{from:0,to:70,color:'#30B32D'},{from:70,to:90,color:'#FFDD00'},{from:90,to:120,color:'#F03E3E'}]
      }).draw()
    };
  }

  const gauges = createGauges();

  try {
    const motorId = getParam('motor');
    if(!motorId) throw new Error('Parâmetro ?motor= ausente na URL.');

    // carregar dados iniciais
    const data = await fetchMotor(motorId);

    document.getElementById('titulo').setAttribute('value', data.nome);

    gauges.torqueGauge.value = data.torque;
    gauges.correnteGauge.value = data.corrente;
    gauges.temperaturaGauge.value = data.temperatura;

    gauges.torqueGauge.draw();
    gauges.correnteGauge.draw();
    gauges.temperaturaGauge.draw();

    // atualizações contínuas
    setInterval(async () => {
      const d = await fetchMotor(motorId);
      gauges.torqueGauge.value = d.torque;
      gauges.correnteGauge.value = d.corrente;
      gauges.temperaturaGauge.value = d.temperatura;

      gauges.torqueGauge.draw();
      gauges.correnteGauge.draw();
      gauges.temperaturaGauge.draw();
    }, 8000);

  } catch(err){
    showError(err.message);
  }

})();
</script>

</body>
</html>
