 <!-- Desenvolvido por Liniker Venturini da Silva -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AR Motores – Suzano</title>

  <!-- Gauges -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-gauges@2.1.7/gauge.min.js"></script>

  <!-- js-aruco2 -->
  <script src="https://cdn.jsdelivr.net/npm/js-aruco2@2.0.0/src/aruco.min.js"></script>

  <style>
    body, html { margin:0; padding:0; overflow:hidden; background:#000; }
    #video { position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:1; }
    #overlay { position:absolute; top:0; left:0; width:100%; height:100%; z-index:2; }
    canvas { display:none; }
    #errbox { position:absolute; top:10px; left:10px; color:#fff; background:rgba(0,0,0,0.6); padding:5px 8px; border-radius:5px; z-index:3; display:none; }
  </style>
</head>
<body>
  <video id="video" autoplay playsinline></video>
  <canvas id="overlay"></canvas>
  <div id="errbox"></div>

  <!-- Canvases dos gauges -->
  <canvas id="gTorque" width="512" height="512"></canvas>
  <canvas id="gCorrente" width="512" height="512"></canvas>
  <canvas id="gTemperatura" width="512" height="512"></canvas>

<script>
(async function(){
  const SHEET_ID   = "1W9OPl0BG72_6t0nGy1kaDqfIICkLgG8YnkD_Y5uCb4k";
  const SHEET_NAME = "SERVOS";

  const ARUCO_MAP = {}; // será preenchido dinamicamente

  const video = document.getElementById("video");
  const overlay = document.getElementById("overlay");
  const ctx = overlay.getContext("2d");

  const errbox = document.getElementById("errbox");
  function showError(msg){ errbox.style.display='block'; errbox.textContent=msg; console.error(msg); }

  // ======= GAUGES =======
  function createGauges(){
    return {
      t: new RadialGauge({ renderTo:"gTorque", width:512, height:512, minValue:0, maxValue:100, units:"Torque (Nm)", value:0, majorTicks:["0","20","40","60","80","100"] }).draw(),
      c: new RadialGauge({ renderTo:"gCorrente", width:512, height:512, minValue:0, maxValue:100, units:"Corrente (A)", value:0 }).draw(),
      temp: new RadialGauge({ renderTo:"gTemperatura", width:512, height:512, minValue:0, maxValue:120, units:"Temperatura (°C)", value:0 }).draw()
    };
  }
  const gauges = createGauges();

  // ======= BUSCAR DADOS =======
  async function fetchMotorByAruco(id){
    const tq = `select A,B,C,D,E where A='${id}' limit 1`;
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&tqx=out:json&tq=${encodeURIComponent(tq)}`;
    const txt = await fetch(url).then(r=>r.text());
    const json = JSON.parse(txt.substring(txt.indexOf("{"), txt.lastIndexOf("}")+1));
    const row = json.table.rows[0]?.c;
    if(!row) throw new Error("Motor não encontrado na planilha.");
    return {
      id: row[0]?.v,
      nome: row[1]?.v,
      torque: row[2]?.v,
      corrente: row[3]?.v,
      temperatura: row[4]?.v
    };
  }

  // ======= CAMERA =======
  try{
    const stream = await navigator.mediaDevices.getUserMedia({video:{ facingMode:"environment" }});
    video.srcObject = stream;
    await video.play();
  }catch(e){ showError("Não foi possível acessar a câmera: "+e.message); return; }

  // Ajusta overlay
  function resizeCanvas(){
    overlay.width = video.videoWidth;
    overlay.height = video.videoHeight;
  }
  video.addEventListener("loadedmetadata", resizeCanvas);

  // ======= ARUCO DETECTOR =======
  const detector = new AR.Detector();
  async function loop(){
    ctx.drawImage(video,0,0,overlay.width,overlay.height);
    const imageData = ctx.getImageData(0,0,overlay.width,overlay.height);
    const markers = detector.detect(imageData);

    if(markers.length > 0){
      for(const m of markers){
        const motor = await fetchMotorByAruco(m.id).catch(()=>null);
        if(!motor) continue;

        // Atualiza gauges
        gauges.t.value = motor.torque; gauges.t.draw();
        gauges.c.value = motor.corrente; gauges.c.draw();
        gauges.temp.value = motor.temperatura; gauges.temp.draw();

        // Desenha retângulo e nome sobre o marcador
        ctx.strokeStyle="#00AEEF"; ctx.lineWidth=4;
        ctx.beginPath();
        for(let i=0;i<m.corners.length;i++){
          const c1 = m.corners[i];
          const c2 = m.corners[(i+1)%4];
          ctx.moveTo(c1.x, c1.y);
          ctx.lineTo(c2.x, c2.y);
        }
        ctx.stroke();

        ctx.fillStyle="#00AEEF";
        ctx.font="24px Arial";
        ctx.fillText(motor.nome,m.corners[0].x,m.corners[0].y-10);
      }
    }

    requestAnimationFrame(loop);
  }

  loop();

})();
</script>
</body>
</html>

