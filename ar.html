 <!-- Desenvolvido por Liniker Venturini da Silva -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR Motores – Suzano</title>

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.rawgit.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.min.js"></script>

  <!-- Gauges -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-gauges@2.1.7/gauge.min.js"></script>

  <style>
    body { margin:0; overflow:hidden; background:#000; font-family: Arial; }
    canvas { display:none; }
  </style>
</head>

<body>

<!-- Gauges -->
<canvas id="gTorque" width="512" height="512"></canvas>
<canvas id="gCorrente" width="512" height="512"></canvas>
<canvas id="gTemperatura" width="512" height="512"></canvas>

<a-scene 
  embedded
  arjs="trackingMethod: barcode; barcodeType: aruco; debugUIEnabled: false;"
>
  <a-entity camera></a-entity>

  <!-- UM MARCADOR "GENÉRICO": o JS muda o ID dinamicamente -->
  <a-marker type="barcode" value="0" id="arucoMarker">

      <a-text id="titulo"
              value="Aguardando marcador..."
              position="0 1 0"
              align="center"
              color="#00AEEF"
              width="2">
      </a-text>

      <a-plane position="-0.7 0.25 0" width="0.9" height="0.9"
               material="src: #gTorque; transparent: true"></a-plane>

      <a-plane position="0.7 0.25 0" width="0.9" height="0.9"
               material="src: #gCorrente; transparent: true"></a-plane>

      <a-plane position="0 -0.6 0" width="1.4" height="0.9"
               material="src: #gTemperatura; transparent: true"></a-plane>

  </a-marker>
</a-scene>

<script>
// =============================
// CONFIG
// =============================
const SHEET_ID   = "1W9OPl0BG72_6t0nGy1kaDqfIICkLgG8YnkD_Y5uCb4k";
const SHEET_NAME = "SERVOS";

// =============================
// GAUGES
// =============================
function createGauges(){
  return {
    torque: new RadialGauge({
      renderTo:"gTorque", width:512, height:512,
      minValue:0, maxValue:100, units:"Torque (Nm)", value:0
    }).draw(),
    corrente: new RadialGauge({
      renderTo:"gCorrente", width:512, height:512,
      minValue:0, maxValue:100, units:"Corrente (A)", value:0
    }).draw(),
    temperatura: new RadialGauge({
      renderTo:"gTemperatura", width:512, height:512,
      minValue:0, maxValue:200, units:"Temperatura (°C)", value:0
    }).draw()
  };
}
const gauges = createGauges();

// =============================
// BUSCA DINÂMICA PELO ID DO ARUCO
// =============================
async function fetchMotorByAruco(idAruco){
  const query = `select A,B,C,D where A=${idAruco} limit 1`;
  const url   = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&tqx=out:json&tq=${encodeURIComponent(query)}`;

  try {
    const txt  = await fetch(url).then(r => r.text());
    const json = JSON.parse(txt.substring(txt.indexOf("{"), txt.lastIndexOf("}")+1));
    const row  = json.table.rows[0].c;

    return {
      nome:        row[1].v,
      torque:      row[2].v,
      corrente:    row[3].v,
      temperatura: row[4].v
    };

  } catch(e){
    return null;
  }
}

// =============================
// DETECTAR O ID REAL DO MARCADOR
// =============================
AFRAME.registerComponent("aruco-listener", {
  tick: function(){
    const marker = document.querySelector("#arucoMarker");
    if(marker && marker.object3D.visible){
      const realId = marker.components["marker"].data.value;

      updateMotor(realId);
    }
  }
});

document.querySelector("#arucoMarker").setAttribute("aruco-listener","");

// =============================
let lastId = null;

async function updateMotor(id){
  if(id === lastId) return;
  lastId = id;

  const data = await fetchMotorByAruco(id);
  if(!data){
    document.querySelector("#titulo").setAttribute("value", "Sem dados para ID " + id);
    return;
  }

  document.querySelector("#titulo").setAttribute("value", data.nome);

  gauges.torque.value      = data.torque;
  gauges.corrente.value    = data.corrente;
  gauges.temperatura.value = data.temperatura;

  gauges.torque.draw();
  gauges.corrente.draw();
  gauges.temperatura.draw();
}

</script>

</body>
</html>
